import pytest
import handler


def test_main(monkeypatch):
    monkeypatch.setenv(
        'email_bucket', 'gb-shovel-dev-serverlessdeploymentbucket-cljc3nttf1nd')
    monkeypatch.setenv('email_bucket_prefix', 'ses-email')
    monkeypatch.setenv('log_level', 'DEBUG')
    monkeypatch.setenv('region', 'eu-west-1')
    monkeypatch.setenv('email_forward_rules',
                       '{"test@almenbostader.se": "almenbostader@gmail.com"}')
    monkeypatch.setenv('email_encryption_kms_key_arn',
                       'arn:aws:kms:eu-west-1:737354003986:alias/aws/ses')
    monkeypatch.setenv('aws_account_id', '737354003986')
    monkeypatch.setenv('ses_receipt_rule', 'gb-shovel-dev')

    context = {}
    event = {'Records': [{'eventSource': 'aws:ses', 'eventVersion': '1.0', 'ses': {'mail': {'timestamp': '2020-04-08T13:45:10.346Z', 'source': 'love.lundin@glockenbach.se', 'messageId': 'bvg8eer9lr8mp5u7id62bjtofufd61m48f65oog1', 'destination': ['test@almenbostader.se'], 'headersTruncated': False, 'headers': [{'name': 'Return-Path', 'value': '<love.lundin@glockenbach.se>'}, {'name': 'Received', 'value': 'from mail-qt1-f169.google.com (mail-qt1-f169.google.com [209.85.160.169]) by inbound-smtp.eu-west-1.amazonaws.com with SMTP id bvg8eer9lr8mp5u7id62bjtofufd61m48f65oog1 for test@almenbostader.se; Wed, 08 Apr 2020 13:45:10 +0000 (UTC)'}, {'name': 'Received-SPF', 'value': 'none (spfCheck: 209.85.160.169 is neither permitted nor denied by domain of glockenbach.se) client-ip=209.85.160.169; envelope-from=love.lundin@glockenbach.se; helo=mail-qt1-f169.google.com;'}, {'name': 'Authentication-Results', 'value': 'amazonses.com; spf=none (spfCheck: 209.85.160.169 is neither permitted nor denied by domain of glockenbach.se) client-ip=209.85.160.169; envelope-from=love.lundin@glockenbach.se; helo=mail-qt1-f169.google.com; dkim=pass header.i=@glockenbach-se.20150623.gappssmtp.com; dmarc=none header.from=glockenbach.se;'}, {'name': 'X-SES-RECEIPT', 'value': 'AEFBQUFBQUFBQUFHQXhBWm54RlFVZzZzQnROU0pHMHV4SDVRNlJjL2Z1RWhDaUs5Qk5pSVpwT1dmbUhrZ0tzTGNGdW9pc2EyMmJHL293RUhrMjY5SUVxS1RRSDYrTXdtVFFSMUJkOXlsamxjMzBSdnNreDFySUs5aVhZTms4T2hXMkNhY1pyTEVRaVYvaU0rcWpCNVJqeEJNN3FLSko4TWNGS0ZEb1hENzlkeUE2blQwTzZXaGdQanFPZVQxam54Q1czT2RaVDFudmM4eXZydzVvSHg5MHFETGFUeks3bUF2RjBpa2NlQWIyVTlSQjM1OWd0cWVHMi8wbDFKcHFVMUxkOE9xbkF6dkZiZUJyeHJ4eHFwRHdsRWtCNnphWXBGNEF0U1pFM0o0c1B1Uit4UUVCMVpWTUE9PQ=='}, {'name': 'X-SES-DKIM-SIGNATURE', 'value': 'a=rsa-sha256; q=dns/txt; b=qp3Rhc//LV5fSpsBxvHO17CTl/leZ74HQcMltkfLQ8OhFnr2Rb4Zxz/JitKD3L5i2AsRhlQ7zeHTizNoYmk/uT/RBIcxUBC5aT8BlIbPmvku+SIFYdpxF2rXKDM8x+iXT8reE3z9HUnYmAQgiCOxg/gGrwNyqkPzZqZghITvJSw=; c=relaxed/simple; s=shh3fegwg5fppqsuzphvschd53n6ihuv; d=amazonses.com; t=1586353510; v=1; bh=afGpZCmxB1t+YmjD7mTWufEZ4MjYKI8rwq3aqaGAyIg=; h=From:To:Cc:Bcc:Subject:Date:Message-ID:MIME-Version:Content-Type:X-SES-RECEIPT;'}, {'name': 'Received', 'value': 'by mail-qt1-f169.google.com with SMTP id 14so5596018qtp.1 for <test@almenbostader.se>; Wed, 08 Apr 2020 06:45:10 -0700 (PDT)'}, {'name': 'DKIM-Signature', 'value': 'v=1; a=rsa-sha256; c=relaxed/relaxed; d=glockenbach-se.20150623.gappssmtp.com; s=20150623; h=mime-version:from:date:message-id:subject:to; bh=afGpZCmxB1t+YmjD7mTWufEZ4MjYKI8rwq3aqaGAyIg=; b=YW3JmFSTeZlKSjAj0djHTIHhQwiFHQTeOLKF2NoXhy5IWMJy3P0m4B30CjbfIEB/oLs6P8FpRmAUO1h42NBXxHwwsV8kGor+LLsD78K0rDCz6loEnxEtu12ZQBrIoGF1lxskKlq9s5wxycKxn6H1IRuHi+a7G3xY6HW9fyJiXzw8aCGgCGTr5wlm7/evZ7vRLAL3K8BRU2e8GvjGENd+I60+5YUD6jIB0xr3082skfHUdf5QhortDXsPlNo41BFihPuF3Bj1z/ueaPOwJvRo68OvC5IP94WYTJnxGQr0fSmGCezuZl9/fte7tcxAzEZd6wcjhkHijXD8xkT/rFZAlA=='}, {
        'name': 'X-Google-DKIM-Signature', 'value': 'v=1; a=rsa-sha256; c=relaxed/relaxed; d=1e100.net; s=20161025; h=x-gm-message-state:mime-version:from:date:message-id:subject:to; bh=afGpZCmxB1t+YmjD7mTWufEZ4MjYKI8rwq3aqaGAyIg=; b=aFzP+V7NL5tDkbXhARkCKUaRp42rtGZt/9vP7rcyr2FvkoTp17g2VXE0nMsoSnPGu1 yrhKAio0MtnBfolQbhB4wkgSxzjjqOIZPsXdmkLvY050Uc1NgyvRoP3PPL4S3tC1qMUe 37YgLObVqVJq3cQuoywMmoee1+dADNHoUaoEdfAlykf7BGsSPuXR83amOQatbwbg7s/h ILsOu0RyGQ1h8xdrC9Yt2Be1UBvd7RQj5RF69+cnkwvPn8GwdqOysKK8H6z6mVYwo4F5 iEAyGAlrNsI9B4hjAwHUsPZeYsW11FKOtAFe2vw7iGaLKds0/2ZU9d66HO7oZRj2iLKG S8vQ=='}, {'name': 'X-Gm-Message-State', 'value': 'AGi0PuaMnPfOBKcQ1vDGs2fAmTvHM7nwLP3wYZoa3fhz1UzkOnRNHEAo hsWe2N/PAvc6FqBwfpprXLTM6n7GN1Lcga8Eu6/xP5YMFtBZJw=='}, {'name': 'X-Google-Smtp-Source', 'value': 'APiQypIPJl6C5dynu2EveW48Zvo9N+c9PAjnZ4G5bpzfegWFsn/2/OAwhegzcXhz7lGvXo+jpa6Piq+In9YyfN8lph8='}, {'name': 'X-Received', 'value': 'by 2002:ac8:4a98:: with SMTP id l24mr7578587qtq.223.1586353508681; Wed, 08 Apr 2020 06:45:08 -0700 (PDT)'}, {'name': 'MIME-Version', 'value': '1.0'}, {'name': 'From', 'value': 'Love Lundin <love.lundin@glockenbach.se>'}, {'name': 'Date', 'value': 'Wed, 8 Apr 2020 15:44:57 +0200'}, {'name': 'Message-ID', 'value': '<CAE18HTY=fptccQUWbqEqAQsfpXfdDV0bSih_RcBa1wAKn-TBEw@mail.gmail.com>'}, {'name': 'Subject', 'value': '2020-04-08 - TEST 1'}, {'name': 'To', 'value': 'Almen Bostäder <test@almenbostader.se>'}, {'name': 'Content-Type', 'value': 'multipart/alternative; boundary="0000000000005fcc6b05a2c7b599"'}], 'commonHeaders': {'returnPath': 'love.lundin@glockenbach.se', 'from': ['Love Lundin <love.lundin@glockenbach.se>'], 'date': 'Wed, 8 Apr 2020 15:44:57 +0200', 'to': ['"Almen Bostäder" <test@almenbostader.se>'], 'messageId': '<CAE18HTY=fptccQUWbqEqAQsfpXfdDV0bSih_RcBa1wAKn-TBEw@mail.gmail.com>', 'subject': '2020-04-08 - TEST 1'}}, 'receipt': {'timestamp': '2020-04-08T13:45:10.346Z', 'processingTimeMillis': 647, 'recipients': ['test@almenbostader.se'], 'spamVerdict': {'status': 'DISABLED'}, 'virusVerdict': {'status': 'DISABLED'}, 'spfVerdict': {'status': 'GRAY'}, 'dkimVerdict': {'status': 'GRAY'}, 'dmarcVerdict': {'status': 'GRAY'}, 'action': {'type': 'Lambda', 'functionArn': 'arn:aws:lambda:eu-west-1:737354003986:function:gb-shovel-dev-main', 'invocationType': 'RequestResponse'}}}}]}

    handler.main(event, context)
